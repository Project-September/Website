# GitHub Pagesç”¨ã®Hugoã‚µã‚¤ãƒˆãƒ“ãƒ«ãƒ‰ãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
name: Deploy Hugo site to Pages

on:
    # mainãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥æ™‚ã«å®Ÿè¡Œ
    push:
        branches:
            - main

    # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½
    pull_request:
        branches:
            - main

    # æ‰‹å‹•å®Ÿè¡Œã‚’è¨±å¯
    workflow_dispatch:

# GitHub Pagesã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤æ¨©é™ã‚’è¨­å®š
permissions:
    contents: read
    pages: write
    id-token: write

# åŒæ™‚å®Ÿè¡Œã‚’åˆ¶é™ï¼ˆæ–°ã—ã„ãƒ‡ãƒ—ãƒ­ã‚¤ãŒé–‹å§‹ã•ã‚ŒãŸã‚‰å¤ã„ã‚‚ã®ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼‰
concurrency:
    group: "pages"
    cancel-in-progress: false

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚·ã‚§ãƒ«è¨­å®š
defaults:
    run:
        shell: bash

jobs:
    # ãƒ“ãƒ«ãƒ‰ã‚¸ãƒ§ãƒ–
    build:
        runs-on: ubuntu-latest
        env:
            HUGO_VERSION: 0.148.2
        steps:
            - name: Hugoã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
              run: |
                  set -e
                  wget -O ${{ runner.temp }}/hugo.deb https://github.com/gohugoio/hugo/releases/download/v${HUGO_VERSION}/hugo_extended_${HUGO_VERSION}_linux-amd64.deb \
                  && sudo dpkg -i ${{ runner.temp }}/hugo.deb
              continue-on-error: false

            - name: Gitã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
              run: |
                  set -e
                  sudo apt-get update
                  sudo apt-get install -y git
              continue-on-error: false

            - name: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
              uses: actions/checkout@v4
              with:
                  submodules: recursive
                  fetch-depth: 0

            - name: GitHub Pagesã®è¨­å®š
              id: pages
              uses: actions/configure-pages@v4
              if: github.event_name != 'pull_request'

            - name: Node.jsã®è¨­å®šï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
              uses: actions/setup-node@v4
              with:
                  node-version: "18"
                  cache: "npm"
                  cache-dependency-path: "**/package-lock.json"

            - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
              run: |
                  if [ -f package-lock.json ]; then
                      npm ci
                  fi
              continue-on-error: false

            - name: ã‚³ãƒ³ãƒ†ãƒ³ãƒ„æ¤œè¨¼
              run: |
                  set -e
                  if [ -f scripts/validate-content.sh ]; then
                      chmod +x scripts/validate-content.sh
                      ./scripts/validate-content.sh
                  fi
              continue-on-error: false

            - name: Hugoã§ã‚µã‚¤ãƒˆã‚’ãƒ“ãƒ«ãƒ‰ï¼ˆæœ¬ç•ªç’°å¢ƒï¼‰
              if: github.event_name != 'pull_request'
              env:
                  HUGO_ENVIRONMENT: production
                  HUGO_ENV: production
              run: |
                  set -e
                  hugo \
                    --gc \
                    --minify \
                    --baseURL "${{ steps.pages.outputs.base_url }}/"
              continue-on-error: false

            - name: Hugoã§ã‚µã‚¤ãƒˆã‚’ãƒ“ãƒ«ãƒ‰ï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰
              if: github.event_name == 'pull_request'
              env:
                  HUGO_ENVIRONMENT: preview
                  HUGO_ENV: preview
              run: |
                  set -e
                  hugo \
                    --gc \
                    --minify \
                    --baseURL "https://preview-${{ github.event.number }}.github.io/" \
                    --buildDrafts
              continue-on-error: false

            - name: ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆæœ¬ç•ªç’°å¢ƒï¼‰
              if: github.event_name != 'pull_request'
              uses: actions/upload-pages-artifact@v3
              with:
                  path: ./public

            - name: ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰
              if: github.event_name == 'pull_request'
              uses: actions/upload-artifact@v4
              with:
                  name: preview-site-${{ github.event.number }}
                  path: ./public
                  retention-days: 7

            - name: ãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼é€šçŸ¥
              if: failure()
              run: |
                  echo "::error::Hugo ãƒ“ãƒ«ãƒ‰ãŒå¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
                  echo "::notice::ã‚ˆãã‚ã‚‹ã‚¨ãƒ©ãƒ¼: 1) Markdownæ§‹æ–‡ã‚¨ãƒ©ãƒ¼ 2) å­˜åœ¨ã—ãªã„ç”»åƒã¸ã®å‚ç…§ 3) Front Matteræ§‹æ–‡ã‚¨ãƒ©ãƒ¼"

    # ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¸ãƒ§ãƒ–ï¼ˆæœ¬ç•ªç’°å¢ƒã®ã¿ï¼‰
    deploy:
        if: github.event_name != 'pull_request'
        environment:
            name: github-pages
            url: ${{ steps.deployment.outputs.page_url }}
        runs-on: ubuntu-latest
        needs: build
        steps:
            - name: GitHub Pagesã«ãƒ‡ãƒ—ãƒ­ã‚¤
              id: deployment
              uses: actions/deploy-pages@v4
              continue-on-error: false

            - name: ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸé€šçŸ¥
              if: success()
              run: |
                  echo "::notice::ã‚µã‚¤ãƒˆãŒæ­£å¸¸ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¾ã—ãŸ: ${{ steps.deployment.outputs.page_url }}"

            - name: ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¨ãƒ©ãƒ¼é€šçŸ¥
              if: failure()
              run: |
                  echo "::error::GitHub Pagesã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¤±æ•—ã—ã¾ã—ãŸã€‚"
                  echo "::notice::å¯¾å‡¦æ³•: 1) ãƒªãƒã‚¸ãƒˆãƒªè¨­å®šã§Pagesæ©Ÿèƒ½ãŒæœ‰åŠ¹ã‹ç¢ºèª 2) ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æ¨©é™ã‚’ç¢ºèª 3) å‰å›ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã‚’ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯"

    # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆ
    preview-comment:
        if: github.event_name == 'pull_request'
        runs-on: ubuntu-latest
        needs: build
        permissions:
            pull-requests: write
        steps:
            - name: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ¡ãƒ³ãƒˆ
              uses: actions/github-script@v7
              with:
                  script: |
                      const { data: comments } = await github.rest.issues.listComments({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          issue_number: context.issue.number,
                      });

                      const botComment = comments.find(comment => 
                          comment.user.type === 'Bot' && comment.body.includes('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼')
                      );

                      const commentBody = `## ğŸš€ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æº–å‚™å®Œäº†

                      ã“ã®ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚

                      ğŸ“¦ **ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆ**: \`preview-site-${{ github.event.number }}\`
                      â° **ä¿æŒæœŸé–“**: 7æ—¥é–“

                      ### ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ç¢ºèªæ–¹æ³•
                      1. ä¸Šè¨˜ã®ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                      2. ãƒ­ãƒ¼ã‚«ãƒ«ã§HTTPã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã—ã¦ç¢ºèª

                      \`\`\`bash
                      # ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å±•é–‹å¾Œ
                      cd public
                      python -m http.server 8000
                      # http://localhost:8000 ã§ã‚¢ã‚¯ã‚»ã‚¹
                      \`\`\`

                      ---
                      *ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*`;

                      if (botComment) {
                          await github.rest.issues.updateComment({
                              owner: context.repo.owner,
                              repo: context.repo.repo,
                              comment_id: botComment.id,
                              body: commentBody
                          });
                      } else {
                          await github.rest.issues.createComment({
                              owner: context.repo.owner,
                              repo: context.repo.repo,
                              issue_number: context.issue.number,
                              body: commentBody
                          });
                      }
