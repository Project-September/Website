# GitHub Pages ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
name: Rollback GitHub Pages

on:
    # æ‰‹å‹•å®Ÿè¡Œã®ã¿
    workflow_dispatch:
        inputs:
            commit_sha:
                description: "ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å…ˆã®ã‚³ãƒŸãƒƒãƒˆSHAï¼ˆç©ºã®å ´åˆã¯ç›´å‰ã®ã‚³ãƒŸãƒƒãƒˆï¼‰"
                required: false
                type: string
            reason:
                description: "ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã®ç†ç”±"
                required: true
                type: string

# GitHub Pagesã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤æ¨©é™ã‚’è¨­å®š
permissions:
    contents: read
    pages: write
    id-token: write
    actions: read

# åŒæ™‚å®Ÿè¡Œã‚’åˆ¶é™
concurrency:
    group: "pages-rollback"
    cancel-in-progress: false

jobs:
    # ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œå‰ã®ç¢ºèª
    confirm-rollback:
        runs-on: ubuntu-latest
        outputs:
            target_commit: ${{ steps.determine-commit.outputs.commit }}
            target_commit_message: ${{ steps.get-commit-info.outputs.message }}
        steps:
            - name: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å¯¾è±¡ã‚³ãƒŸãƒƒãƒˆã®æ±ºå®š
              id: determine-commit
              run: |
                  if [ -n "${{ github.event.inputs.commit_sha }}" ]; then
                      TARGET_COMMIT="${{ github.event.inputs.commit_sha }}"
                  else
                      # ç›´å‰ã®ã‚³ãƒŸãƒƒãƒˆã‚’å–å¾—
                      TARGET_COMMIT=$(git rev-parse HEAD~1)
                  fi

                  # ã‚³ãƒŸãƒƒãƒˆãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
                  if ! git cat-file -e "$TARGET_COMMIT^{commit}" 2>/dev/null; then
                      echo "::error::æŒ‡å®šã•ã‚ŒãŸã‚³ãƒŸãƒƒãƒˆ $TARGET_COMMIT ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
                      exit 1
                  fi

                  echo "commit=$TARGET_COMMIT" >> $GITHUB_OUTPUT
                  echo "::notice::ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å¯¾è±¡: $TARGET_COMMIT"

            - name: ã‚³ãƒŸãƒƒãƒˆæƒ…å ±ã®å–å¾—
              id: get-commit-info
              run: |
                  COMMIT_MESSAGE=$(git log -1 --pretty=format:"%s" ${{ steps.determine-commit.outputs.commit }})
                  echo "message=$COMMIT_MESSAGE" >> $GITHUB_OUTPUT
                  echo "::notice::ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: $COMMIT_MESSAGE"

            - name: ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æƒ…å ±ã®è¡¨ç¤º
              run: |
                  echo "## ğŸ”„ ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œæƒ…å ±"
                  echo "**å¯¾è±¡ã‚³ãƒŸãƒƒãƒˆ**: ${{ steps.determine-commit.outputs.commit }}"
                  echo "**ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸**: ${{ steps.get-commit-info.outputs.message }}"
                  echo "**ç†ç”±**: ${{ github.event.inputs.reason }}"
                  echo "**å®Ÿè¡Œè€…**: ${{ github.actor }}"
                  echo "**å®Ÿè¡Œæ™‚åˆ»**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"

    # ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ãƒ“ãƒ«ãƒ‰
    rollback-build:
        runs-on: ubuntu-latest
        needs: confirm-rollback
        env:
            HUGO_VERSION: 0.148.2
        steps:
            - name: Hugoã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
              run: |
                  set -e
                  wget -O ${{ runner.temp }}/hugo.deb https://github.com/gohugoio/hugo/releases/download/v${HUGO_VERSION}/hugo_extended_${HUGO_VERSION}_linux-amd64.deb \
                  && sudo dpkg -i ${{ runner.temp }}/hugo.deb

            - name: æŒ‡å®šã‚³ãƒŸãƒƒãƒˆã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
              uses: actions/checkout@v4
              with:
                  ref: ${{ needs.confirm-rollback.outputs.target_commit }}
                  submodules: recursive
                  fetch-depth: 0

            - name: GitHub Pagesã®è¨­å®š
              id: pages
              uses: actions/configure-pages@v4

            - name: Node.jsã®è¨­å®š
              uses: actions/setup-node@v4
              with:
                  node-version: "18"
                  cache: "npm"
                  cache-dependency-path: "**/package-lock.json"

            - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
              run: |
                  if [ -f package-lock.json ]; then
                      npm ci
                  fi

            - name: ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ã‚µã‚¤ãƒˆãƒ“ãƒ«ãƒ‰
              env:
                  HUGO_ENVIRONMENT: production
                  HUGO_ENV: production
              run: |
                  set -e
                  echo "::notice::ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ã‚µã‚¤ãƒˆã‚’ãƒ“ãƒ«ãƒ‰ä¸­..."
                  hugo \
                    --gc \
                    --minify \
                    --baseURL "${{ steps.pages.outputs.base_url }}/"

            - name: ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
              uses: actions/upload-pages-artifact@v3
              with:
                  path: ./public

            - name: ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æº–å‚™å®Œäº†é€šçŸ¥
              run: |
                  echo "::notice::ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ãƒ“ãƒ«ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸ"
                  echo "::notice::å¯¾è±¡ã‚³ãƒŸãƒƒãƒˆ: ${{ needs.confirm-rollback.outputs.target_commit }}"

    # ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œ
    rollback-deploy:
        environment:
            name: github-pages
            url: ${{ steps.deployment.outputs.page_url }}
        runs-on: ubuntu-latest
        needs: [confirm-rollback, rollback-build]
        steps:
            - name: ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œ
              id: deployment
              uses: actions/deploy-pages@v4

            - name: ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æˆåŠŸé€šçŸ¥
              if: success()
              run: |
                  echo "::notice::ğŸ‰ ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ"
                  echo "::notice::ã‚µã‚¤ãƒˆURL: ${{ steps.deployment.outputs.page_url }}"
                  echo "::notice::ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å…ˆ: ${{ needs.confirm-rollback.outputs.target_commit }}"
                  echo "::notice::ç†ç”±: ${{ github.event.inputs.reason }}"

            - name: ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å¤±æ•—é€šçŸ¥
              if: failure()
              run: |
                  echo "::error::âŒ ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒå¤±æ•—ã—ã¾ã—ãŸ"
                  echo "::error::å¯¾è±¡ã‚³ãƒŸãƒƒãƒˆ: ${{ needs.confirm-rollback.outputs.target_commit }}"
                  echo "::notice::å¯¾å‡¦æ³•:"
                  echo "::notice::1. æŒ‡å®šã—ãŸã‚³ãƒŸãƒƒãƒˆSHAãŒæ­£ã—ã„ã‹ç¢ºèª"
                  echo "::notice::2. ãã®ã‚³ãƒŸãƒƒãƒˆã§ã‚µã‚¤ãƒˆãŒæ­£å¸¸ã«ãƒ“ãƒ«ãƒ‰ã§ãã‚‹ã‹ç¢ºèª"
                  echo "::notice::3. GitHub Pagesè¨­å®šã‚’ç¢ºèª"

    # ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å¾Œã®é€šçŸ¥
    post-rollback:
        runs-on: ubuntu-latest
        needs: [confirm-rollback, rollback-deploy]
        if: always()
        steps:
            - name: ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯çµæœã®è¨˜éŒ²
              uses: actions/github-script@v7
              with:
                  script: |
                      const fs = require('fs');
                      const rollbackInfo = {
                          timestamp: new Date().toISOString(),
                          actor: '${{ github.actor }}',
                          reason: '${{ github.event.inputs.reason }}',
                          target_commit: '${{ needs.confirm-rollback.outputs.target_commit }}',
                          target_commit_message: '${{ needs.confirm-rollback.outputs.target_commit_message }}',
                          success: '${{ needs.rollback-deploy.result }}' === 'success',
                          workflow_run_id: '${{ github.run_id }}'
                      };

                      console.log('ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æƒ…å ±:', JSON.stringify(rollbackInfo, null, 2));

                      // Issueä½œæˆï¼ˆå¤±æ•—æ™‚ã®ã¿ï¼‰
                      if (!rollbackInfo.success) {
                          await github.rest.issues.create({
                              owner: context.repo.owner,
                              repo: context.repo.repo,
                              title: `ğŸš¨ ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å¤±æ•—: ${rollbackInfo.reason}`,
                              body: `## ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å¤±æ•—ãƒ¬ãƒãƒ¼ãƒˆ

                      **å®Ÿè¡Œæ™‚åˆ»**: ${rollbackInfo.timestamp}
                      **å®Ÿè¡Œè€…**: ${rollbackInfo.actor}
                      **ç†ç”±**: ${rollbackInfo.reason}
                      **å¯¾è±¡ã‚³ãƒŸãƒƒãƒˆ**: ${rollbackInfo.target_commit}
                      **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œ**: https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${rollbackInfo.workflow_run_id}

                      ### å¯¾å‡¦ãŒå¿…è¦ãªé …ç›®
                      - [ ] ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã®ç¢ºèª
                      - [ ] å¯¾è±¡ã‚³ãƒŸãƒƒãƒˆã®æ¤œè¨¼
                      - [ ] æ‰‹å‹•ã§ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œ
                      - [ ] GitHub Pagesè¨­å®šã®ç¢ºèª

                      ã“ã®Issueã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚`,
                              labels: ['bug', 'deployment', 'rollback']
                          });
                      }
