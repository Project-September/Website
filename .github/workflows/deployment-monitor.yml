# ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆç›£è¦–ã¨ã‚¨ãƒ©ãƒ¼é€šçŸ¥ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
name: Deployment Monitor

on:
    workflow_run:
        workflows: ["Deploy Hugo site to Pages"]
        types:
            - completed

permissions:
    issues: write
    contents: read

jobs:
    monitor-deployment:
        runs-on: ubuntu-latest
        if: ${{ github.event.workflow_run.conclusion == 'failure' }}
        steps:
            - name: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
              uses: actions/checkout@v4

            - name: ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—ã®è©³ç´°å–å¾—
              id: get-failure-info
              uses: actions/github-script@v7
              with:
                  script: |
                      const workflowRun = context.payload.workflow_run;

                      // ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œã®è©³ç´°ã‚’å–å¾—
                      const { data: jobs } = await github.rest.actions.listJobsForWorkflowRun({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          run_id: workflowRun.id
                      });

                      const failedJobs = jobs.jobs.filter(job => job.conclusion === 'failure');

                      let failureDetails = '';
                      for (const job of failedJobs) {
                          failureDetails += `### âŒ ${job.name}\n`;
                          failureDetails += `**é–‹å§‹æ™‚åˆ»**: ${job.started_at}\n`;
                          failureDetails += `**çµ‚äº†æ™‚åˆ»**: ${job.completed_at}\n`;
                          failureDetails += `**ãƒ­ã‚°URL**: ${job.html_url}\n\n`;
                          
                          // å¤±æ•—ã—ãŸã‚¹ãƒ†ãƒƒãƒ—ã®è©³ç´°
                          const failedSteps = job.steps.filter(step => step.conclusion === 'failure');
                          if (failedSteps.length > 0) {
                              failureDetails += '**å¤±æ•—ã—ãŸã‚¹ãƒ†ãƒƒãƒ—**:\n';
                              for (const step of failedSteps) {
                                  failureDetails += `- ${step.name}\n`;
                              }
                              failureDetails += '\n';
                          }
                      }

                      core.setOutput('failure_details', failureDetails);
                      core.setOutput('commit_sha', workflowRun.head_sha);
                      core.setOutput('commit_message', workflowRun.head_commit.message);
                      core.setOutput('actor', workflowRun.actor.login);
                      core.setOutput('workflow_url', workflowRun.html_url);

            - name: æ—¢å­˜ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¨ãƒ©ãƒ¼Issueã‚’æ¤œç´¢
              id: find-existing-issue
              uses: actions/github-script@v7
              with:
                  script: |
                      const { data: issues } = await github.rest.issues.listForRepo({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          labels: 'deployment-error',
                          state: 'open'
                      });

                      const existingIssue = issues.find(issue => 
                          issue.title.includes('ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã‚¨ãƒ©ãƒ¼')
                      );

                      if (existingIssue) {
                          core.setOutput('issue_number', existingIssue.number);
                          return existingIssue.number;
                      }
                      return null;

            - name: ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¨ãƒ©ãƒ¼Issueã®ä½œæˆã¾ãŸã¯æ›´æ–°
              uses: actions/github-script@v7
              with:
                  script: |
                      const failureDetails = `${{ steps.get-failure-info.outputs.failure_details }}`;
                      const commitSha = `${{ steps.get-failure-info.outputs.commit_sha }}`;
                      const commitMessage = `${{ steps.get-failure-info.outputs.commit_message }}`;
                      const actor = `${{ steps.get-failure-info.outputs.actor }}`;
                      const workflowUrl = `${{ steps.get-failure-info.outputs.workflow_url }}`;
                      const existingIssueNumber = `${{ steps.find-existing-issue.outputs.issue_number }}`;

                      const issueBody = `## ğŸš¨ ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ

                      **ç™ºç”Ÿæ™‚åˆ»**: ${new Date().toISOString()}
                      **ã‚³ãƒŸãƒƒãƒˆ**: ${commitSha.substring(0, 7)}
                      **ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸**: ${commitMessage}
                      **å®Ÿè¡Œè€…**: @${actor}
                      **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œ**: ${workflowUrl}

                      ### ã‚¨ãƒ©ãƒ¼è©³ç´°
                      ${failureDetails}

                      ### æ¨å¥¨å¯¾å‡¦æ³•

                      #### 1. ã‚ˆãã‚ã‚‹ã‚¨ãƒ©ãƒ¼ã¨è§£æ±ºæ–¹æ³•

                      **Hugoãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼**:
                      - Markdownæ§‹æ–‡ã‚¨ãƒ©ãƒ¼ â†’ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ•ã‚¡ã‚¤ãƒ«ã®æ§‹æ–‡ç¢ºèª
                      - å­˜åœ¨ã—ãªã„ç”»åƒå‚ç…§ â†’ ç”»åƒãƒ‘ã‚¹ã®ç¢ºèª
                      - Front Matteræ§‹æ–‡ã‚¨ãƒ©ãƒ¼ â†’ YAMLãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®ç¢ºèª

                      **GitHub Pages ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¨ãƒ©ãƒ¼**:
                      - æ¨©é™ä¸è¶³ â†’ ãƒªãƒã‚¸ãƒˆãƒªè¨­å®šã®ç¢ºèª
                      - Pagesè¨­å®š â†’ Settings > Pages ã§ GitHub Actions ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

                      **ä¾å­˜é–¢ä¿‚ã‚¨ãƒ©ãƒ¼**:
                      - Node.js/npm ã‚¨ãƒ©ãƒ¼ â†’ package.json ã¨ package-lock.json ã®ç¢ºèª
                      - Hugo ãƒãƒ¼ã‚¸ãƒ§ãƒ³ â†’ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®Hugo ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª

                      #### 2. ç·Šæ€¥å¯¾å¿œ

                      **å³åº§ã«ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒå¿…è¦ãªå ´åˆ**:
                      1. [ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼](../../actions/workflows/rollback.yml) ã‚’æ‰‹å‹•å®Ÿè¡Œ
                      2. ç›´å‰ã®æ­£å¸¸ãªã‚³ãƒŸãƒƒãƒˆSHAã‚’æŒ‡å®š
                      3. ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ç†ç”±ã‚’è¨˜å…¥

                      **æ‰‹å‹•ã§ã®ãƒ­ãƒ¼ã‚«ãƒ«ç¢ºèª**:
                      \`\`\`bash
                      # ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ
                      hugo --gc --minify

                      # ãƒ­ãƒ¼ã‚«ãƒ«ã‚µãƒ¼ãƒãƒ¼ã§ç¢ºèª
                      hugo server -D
                      \`\`\`

                      #### 3. æ ¹æœ¬åŸå› ã®èª¿æŸ»

                      - [ ] ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã®è©³ç´°ç¢ºèª
                      - [ ] å•é¡Œã®ã‚ã‚‹ã‚³ãƒŸãƒƒãƒˆã®ç‰¹å®š
                      - [ ] ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ã®å†ç¾
                      - [ ] ä¿®æ­£ã¨ãƒ†ã‚¹ãƒˆ

                      ### ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

                      - [ ] ã‚¨ãƒ©ãƒ¼ã®åŸå› ã‚’ç‰¹å®š
                      - [ ] ä¿®æ­£ã‚’å®Ÿè£…
                      - [ ] ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ†ã‚¹ãƒˆ
                      - [ ] ä¿®æ­£ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤
                      - [ ] ã‚µã‚¤ãƒˆã®å‹•ä½œç¢ºèª

                      ---

                      ã“ã®Issueã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚å•é¡ŒãŒè§£æ±ºã—ãŸã‚‰æ‰‹å‹•ã§ã‚¯ãƒ­ãƒ¼ã‚ºã—ã¦ãã ã•ã„ã€‚`;

                      if (existingIssueNumber) {
                          // æ—¢å­˜ã®Issueã«ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ 
                          await github.rest.issues.createComment({
                              owner: context.repo.owner,
                              repo: context.repo.repo,
                              issue_number: parseInt(existingIssueNumber),
                              body: `## ğŸ”„ æ–°ã—ã„ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ
                              
                              **ç™ºç”Ÿæ™‚åˆ»**: ${new Date().toISOString()}
                              **ã‚³ãƒŸãƒƒãƒˆ**: ${commitSha.substring(0, 7)}
                              **å®Ÿè¡Œè€…**: @${actor}
                              **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼**: ${workflowUrl}
                              
                              ${failureDetails}`
                          });
                      } else {
                          // æ–°ã—ã„Issueã‚’ä½œæˆ
                          await github.rest.issues.create({
                              owner: context.repo.owner,
                              repo: context.repo.repo,
                              title: `ğŸš¨ ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã‚¨ãƒ©ãƒ¼: ${commitMessage.substring(0, 50)}...`,
                              body: issueBody,
                              labels: ['bug', 'deployment-error', 'high-priority']
                          });
                      }

            - name: Slacké€šçŸ¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
              if: env.SLACK_WEBHOOK_URL != ''
              env:
                  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
              run: |
                  curl -X POST -H 'Content-type: application/json' \
                    --data '{
                      "text": "ğŸš¨ GitHub Pages ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã‚¨ãƒ©ãƒ¼",
                      "blocks": [
                        {
                          "type": "section",
                          "text": {
                            "type": "mrkdwn",
                            "text": "*GitHub Pages ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸ*\n\n*ãƒªãƒã‚¸ãƒˆãƒª*: ${{ github.repository }}\n*ã‚³ãƒŸãƒƒãƒˆ*: `${{ steps.get-failure-info.outputs.commit_sha }}`\n*å®Ÿè¡Œè€…*: ${{ steps.get-failure-info.outputs.actor }}"
                          }
                        },
                        {
                          "type": "actions",
                          "elements": [
                            {
                              "type": "button",
                              "text": {
                                "type": "plain_text",
                                "text": "ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ç¢ºèª"
                              },
                              "url": "${{ steps.get-failure-info.outputs.workflow_url }}"
                            },
                            {
                              "type": "button",
                              "text": {
                                "type": "plain_text",
                                "text": "ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œ"
                              },
                              "url": "https://github.com/${{ github.repository }}/actions/workflows/rollback.yml"
                            }
                          ]
                        }
                      ]
                    }' \
                    $SLACK_WEBHOOK_URL

    # ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸæ™‚ã®é€šçŸ¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
    notify-success:
        runs-on: ubuntu-latest
        if: ${{ github.event.workflow_run.conclusion == 'success' }}
        steps:
            - name: ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸã®è¨˜éŒ²
              run: |
                  echo "::notice::âœ… ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ"
                  echo "::notice::ã‚³ãƒŸãƒƒãƒˆ: ${{ github.event.workflow_run.head_sha }}"
                  echo "::notice::å®Ÿè¡Œè€…: ${{ github.event.workflow_run.actor.login }}"

            - name: æ—¢å­˜ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¨ãƒ©ãƒ¼Issueã‚’ã‚¯ãƒ­ãƒ¼ã‚º
              uses: actions/github-script@v7
              with:
                  script: |
                      const { data: issues } = await github.rest.issues.listForRepo({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          labels: 'deployment-error',
                          state: 'open'
                      });

                      for (const issue of issues) {
                          if (issue.title.includes('ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã‚¨ãƒ©ãƒ¼')) {
                              await github.rest.issues.createComment({
                                  owner: context.repo.owner,
                                  repo: context.repo.repo,
                                  issue_number: issue.number,
                                  body: `âœ… **ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ**\n\n**è§£æ±ºæ™‚åˆ»**: ${new Date().toISOString()}\n**ã‚³ãƒŸãƒƒãƒˆ**: ${context.payload.workflow_run.head_sha.substring(0, 7)}\n\nã“ã®Issueã‚’è‡ªå‹•çš„ã«ã‚¯ãƒ­ãƒ¼ã‚ºã—ã¾ã™ã€‚`
                              });
                              
                              await github.rest.issues.update({
                                  owner: context.repo.owner,
                                  repo: context.repo.repo,
                                  issue_number: issue.number,
                                  state: 'closed'
                              });
                          }
                      }
